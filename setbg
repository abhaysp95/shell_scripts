#!/usr/bin/env bash

# write a help menu


# TODO:
# write the set wallpaper path in ~/.config/wallname.txt  {done}
# add --kill flag to kill if the script is daemonized {done, have to suppress error when process is not running generated by if}
# add --restart flag {done, script killed itself and restarted successfully}

save_IFS="${IFS}"

# set wallpaper
save_file="/home/$(logname)/.config/wall.png"
image_path=""
pic_dir="/home/$(logname)/Pictures/bgwallpapers"
cur_wallname="/home/$(logname)/.config/wallname.txt"
launch_dunst="/home/$(logname)/.config/dunst/launchdunst.sh"
time_to_sleep="21600"  # 6 hours
wallpaperset=0
wallpaper_setter=""
wallpaper_setter_args=""

if [ $(which wal 2>/dev/null) != "wal not found" ]; then
	wallpaper_setter="wal"
	wallpaper_setter_args="-i"
elif [ "$(which nitrogen 2>/dev/null)" != "nitrogen not found" ]; then
	wallpaper_setter="nitrogen"
	wallpaper_setter_args="--set-zoom-fill"
elif [ "$(which feh 2>/dev/null)" != "feh not found" ]; then
	wallpaper_setter="feh"
	wallpaper_setter_args="--bg-fil"
else
	echo "Install a wallpaper setter"
	exit 1
fi
echo "Wallpaper Setter is: ${wallpaper_setter}"

# help menu
function get_help() {
	printf "Usage:\tsetbg [--gray] [Options]\n\n"
	printf "\t[no arg]:\t\tNothing will happen(exit with a warning)\n"
	printf "\t[filename]:\t\tIf first arg is image then set it as Wallpaper\n"
	printf "\t[directory]:\t\tIf first arg is directory then choose an image randomly\n"
	printf "\t\t\t\tand set as wallpaper\n"
	printf "\t--gray:\t\t\tIf provided arg with no file or directory name then\n"
	printf "\t\t\t\tchooses a random wallpaper from specified directory in script\n"
	printf "\t--gray [path]:\t\tSame as above options but changes image to grayscale\n"
	printf "\t--gray -c:\t\tSet current set wallpaper in grayscale mode\n"
	printf "\t--autochange, -a:\tPut script with this parameter on startup utility\n"
	printf "\t\t\t\tand it'll change your wallpaper everytime on startup\n"
	printf "\t--daemonize yes:\tMakes the script set random wallpaper\n"
	printf "\t--kill:\t\t\tScript kills itself if running as daemon\n"
	printf "\t--restart:\t\tScript kills and restarts itself again as daemon\n"
	printf "\t--help:\t\t\tShow help\n\n"
	printf "\nChange <pic_dir> variable in script to the desired path of wallpaper's directory\n"
	printf "Change <time_to_sleep> variable provided on top of script according to you\n"
	printf "Wallpaper changed to grayscale are perfectly balanced in RGB color property\n"
	exit 0
}

# script is heavily based on 'if-else' conditions instead of 'case'

# convert to grayscale with balanced rgb
function convert_to_gray() {
	filename="$*"
	write_name "${filename}"
	notify-send -t 1000 "grayscale conversion started"
	convert "$*" \
	\( -clone 0 -channel RG -separate +channel -evaluate-sequence mean \) \
	\( -clone 0 -channel GB -separate +channel -evaluate-sequence mean \) \
	-delete 0 -evaluate-sequence mean "${save_file}"
	notify-send -t 1000 "conversion finished"
}

function write_name() {
	printf "%s" "$1" > ${cur_wallname}
}

function setting_for_pywal() {
	# set theme for dunst
	if [ -f "${HOME}/.cache/wal/colors-dunstrc" ] && [ -f "${HOME}/.config/dunst/dunstrc_bak" ]; then
		pidof dunst >/dev/null && killall dunst
		cat "${HOME}/.config/dunst/dunstrc_bak" "${HOME}/.cache/wal/colors-dunstrc" > "${HOME}/.config/dunst/dunstrc"
		echo "dunst theme updated"
		dunst 2>/dev/null &
		sleep 0.2
		notify-send -t 2000 "Dunst theme updated"
	fi
	# set theme for zathura
	if [ -f "${HOME}/.cache/wal/colors-zathurarc" ] && [ -f "${HOME}/.config/zathura/zathurarc_bak" ]; then
		cat "${HOME}/.config/zathura/zathurarc_bak" "${HOME}/.cache/wal/colors-zathurarc" > "${HOME}/.config/zathura/zathurarc"
		echo "Zathura theme updated"
	fi
	# update ~/.Xresources
	if [ -f "${HOME}/.cache/wal/colors.Xresources" ] && [ -f "${HOME}/.Xresources_bak" ]; then
		cat "${HOME}/.cache/wal/colors.Xresources" "${HOME}/.Xresources_bak" > "${HOME}/.Xresources"
		echo "Xresources Updated"
	fi
	# update telegram theme
	if [ -f "${HOME}/.telegram-palette-gen/telegram-palette-gen" ]; then
		"${HOME}/.telegram-palette-gen/telegram-palette-gen" --wal &
	fi
}

[ "$1" = "--help" ] || [ "$1" == "-h" ] && get_help && exit 0

# if file given, then look no further
[ -f "$1" ] && \  # this check even if you provide the name of directory(fix this too)
	image_path="$*" && \
	cp "$*" "${save_file}" && \
	write_name "$*" && \
	notify-send -t 2500 -i "${save_file}" "Wallpaper changed" && \
	wallpaperset=1

# if given, but not a file
if [ "${wallpaperset}" -ne 1 ]; then
	if [ -n "$1" ]; then
		# if first argument is --gray
		if [ -n "$2" ] && [ "$1" != "--daemonize" ] && [ "$1" != "--gray" ]; then
			# if second argument is a file
			[ -f "$2" ] && convert_to_gray "$2" && \
			notify-send -t 2500 -i "${save_file}" "Wallpaper set after gray conversion"
			# if second argument is a directory
			[ -d "$2" ] && \
				convert_to_gray "$(fd --type f -u -e jpg -e jpeg -e png . "$2" | shuf -n 1)" && \
				notify-send -t 2500 -i "${save_file}" "Random wallpaper set after gray conversion from given directory"
		# if first argument is --gray but there's no second argument, then chose random
		elif [ "$1" = "--gray" ]; then
			if [ -z "$2" ]; then
				convert_to_gray "$(fd --type f -e jpg -e jpeg -e png -u . "${pic_dir}" | shuf -n 1)"
				notify-send -t 2500 -i "${save_file}" "Random wallpaper set after gray conversion"
			elif [ "$2" = "-c" ] || [ "$2" = "--current" ]; then
				if [ -f "${cur_wallname}" ]; then
					convert_to_gray $(cat "${cur_wallname}")
				else
					echo "no file exists named: ${cur_wallname}"
				fi
			fi
		# daemnization part of script
		elif [ "$1" = "--daemonize" ]; then
			if [ -n "$2" ]; then
				flag="$2"
				if [ "${flag}" = "yes" ]; then
					flag="no"
				else
					flag="yes"
				fi
				if [ "${flag}" = "yes" ]; then
					trap '' INT
					cd /home/"$(logname)"/.cache/temp || exit 0
					shift
					while true; do
						image_path=$(fd --type f -u -e jpg -e jpeg -e png . "${pic_dir}" | shuf -n 1)
						write_name "${image_path}"
						cp "${image_path}" "${save_file}"
						notify-send -t 2500 -i "${save_file}" "Random Wallpaper set"
						#setbg -a
						"${wallpaper_setter}" "${wallpaper_setter_args}" "${save_file}"
						setting_for_pywal  # update pywal for other tools
						sleep "${time_to_sleep}"
					done
					exit 0
				fi
				nohup setsid "$0" --daemonize no 2>/home/"$(logname)"/.cache/temp/chwall.err >/home/"$(logname)"/.cache/temp/chwall.log &
			fi
		# kill the script if it's daemonized
			# kill $(ps axh | grep ".*[s]etbg --daemonize.*" | head -n 1 | cut -d' ' -f1)
			# pass {write here}
		elif [ "$1" = "--kill" ]; then
			pid=$(ps aux | grep ".*[s]etbg --daemonize.*" | head -n 1 | cut -d' ' -f 2)
			if [ "${pid}" -gt 0 ]; then
				kill "${pid}"
				echo "Killed process. Process id: ${pid}"
			fi
			# get pid
			# if condition passes, kill script and run again
		elif [ "$1" = "--restart" ]; then
			pid=$(ps aux | grep ".*[s]etbg --daemonize.*" | head -n 1 | cut -d' ' -f 2)
			if [ "${pid}" -gt 0 ]; then
				setbg --kill  # call this script which has --kill flag given previously
				echo "script daemonized"
				setbg --daemonize yes  # restart and daemoniz script
			fi
		# change wallpaper randomly, one time
		elif [ "$1" = "-a" ] || [ "$1" = "--autochange" ]; then
			image_path=$(fd --type f -u -e jpg -e jpeg -e png . "${pic_dir}" | shuf -n 1)
			echo "${image_path}"
			write_name "${image_path}"
			cp "${image_path}" "${save_file}"
			notify-send -t 2500 -i "${save_file}" "Random Wallpaper set"
		# if first argument is not --gray, then it should be a directory
		elif [ "$1" != "--gray" ] && [ -z "$2" ]; then
			[ -d "$1" ] && \
				image_path=$(fd --type f -u -e jpg -e jpeg -e png . "$1" | shuf -n 1) && \
				write_name "${image_path}" && \
				cp "${image_path}" "${save_file}" && \
				notify-send -t 2500 -i "${save_file}" "Random Wallpaper set" || echo "Wrong argument provided. Check help(setbg --help)"
		else
			echo "Wrong argument provided. Check help(setbg --help)"
		fi
	else
		echo "No argument provided. Check help(setbg --help)"
	fi
fi


# getting proper screen size
# convert ~/.config/wall.png -resize 1366x768 ~/.config/wall.png
# convert ~/.config/wall.png -gravity center -background white -extent 177%x100 ~/.config/wall.png

# xwallpaper --zoom ~/.config/wall.png
if [ "${image_path}" != "" ]; then
	"${wallpaper_setter}" "${wallpaper_setter_args}" "${image_path}"
fi
"${wallpaper_setter}" "${wallpaper_setter_args}" "$*"
setting_for_pywal

IFS="${save_IFS}"
